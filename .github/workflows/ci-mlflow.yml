name: ğŸš€ CI/CD - MLflow TensorFlow Re-training & Artifact Storage

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'MLProject/**'
  workflow_dispatch: 

jobs:
  train-and-upload: 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # Langkah 1: Persiapan Lingkungan Conda 
      - name: ğŸ“¦ Setup Conda Environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          environment-file: MLProject/conda.yaml
          activate-environment: smsml-tensorflow-env
          use-only-constructor: true

      # Langkah 2: RUN MLFLOW PROJECT (Re-training)
      - name: ğŸš€ Run MLflow Project and Retrain Model
        id: run-mlflow
        shell: bash # <-- PERBAIKAN: Kembali menggunakan shell: bash
        run: |
          echo "Memulai pelatihan model TensorFlow via MLflow Project..."
          
          # PERBAIKAN KUNCI: Inisialisasi Conda secara eksplisit sebelum mengaktifkan
          source /opt/conda/etc/profile.d/conda.sh
          conda activate smsml-tensorflow-env 
          
          # Jalankan MLflow Project.
          mlflow run MLProject --no-conda
          
          # Ambil Run ID terbaru
          LATEST_RUN_ID=$(mlflow runs list --max-results 1 --experiment-id 0 --lifecycle-stage active --output csv | awk 'NR>1 {print $1}')
          echo "latest_run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT
          echo "Run ID Terbaru yang dibuat: $LATEST_RUN_ID"
          

      # Langkah 3: ARTIFACT STORAGE (Memenuhi kriteria Skilled)
      - name: ğŸ’¾ Upload mlruns Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: tensorflow-model-artefacts-${{ github.run_id }}
          path: mlruns
          retention-days: 7
