name: MLflow CI/CD Docker Workflow

on:
  push:
    branches:
      - main
  # Trigger manual
  workflow_dispatch:

env:
  # Digunakan untuk login ke Docker Hub
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  # Ganti dengan nama image Docker Hub Anda
  DOCKER_IMAGE_NAME: tyasnurkumala/smsml-risk-classifier 
  # Nama Experiment MLflow (sesuai yang digunakan di modelling.py)
  MLFLOW_EXP_NAME: SMSML_CI_CD 
  # Port yang akan diekspos oleh Docker (standar MLflow adalah 8080)
  MODEL_PORT: 8080 
  # Path relatif ke folder mlruns
  MLFLOW_RUNS_PATH: MLProject/mlruns

jobs:
  run-mlflow-and-deploy: 
    runs-on: ubuntu-latest
    
    steps:
      # Langkah 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Langkah 2: Set up Python 3.10.13
      - name: Set up Python 3.10.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.13'

      # Langkah 3: Install dependencies
      - name: Install dependencies and Create Conda Env
        run: |
          echo "Memulai instalasi dependencies dan pembuatan Conda Env..."
          python -m pip install --upgrade pip
          # Instalasi Conda/pip dasar yang dibutuhkan
          pip install mlflow # Instalasi mlflow untuk CLI
          # Membuat environment Conda (berdasarkan MLProject/conda.yaml)
          conda env create -f MLProject/conda.yaml 
          # Instalasi dependencies di luar Conda (jika ada)
          pip install -r MLProject/requirements.txt

      # Langkah 4: Run MLflow Project (Training)
      - name: Run MLflow Project (Training)
        run: |
          echo "Memulai pelatihan model MLflow..."
          cd MLProject 
          # Jalankan skrip di dalam environment Conda
          conda run -n mlflow-env python modelling.py

      # Langkah 5 (Optional, for debugging): Upload MLflow Artifacts
      - name: Upload MLflow Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.run_id }}
          path: ${{ env.MLFLOW_RUNS_PATH }}
          retention-days: 7

      # Langkah 6: Get latest MLflow run_id (Cari Run ID Artefak Model Terbaik)
      # Menggunakan teknik Python Here-Document (EOF) untuk menghindari error YAML.
      - name: Get Latest Model Artifact Path
        id: get_model_path
        run: |
          echo "Mencari Run ID MLflow terbaru..."
          
          # Setup URI ke lokasi mlruns
          export MLFLOW_TRACKING_URI="${{ env.MLFLOW_RUNS_PATH }}" 
          
          # Jalankan skrip Python multi-baris
          RUN_ID=$(conda run -n mlflow-env python - << EOF
import mlflow
import os
import pandas as pd # Tambahkan jika MLflow Search Runs mengembalikan DataFrame
import sys

# Setup Tracking URI
experiment_name = os.environ.get('MLFLOW_EXP_NAME', 'Default') 
mlflow.set_tracking_uri(os.environ.get('MLFLOW_TRACKING_URI'))

# Mencari Run terbaru yang Selesai
runs = mlflow.search_runs(
    experiment_names=[experiment_name],
    order_by=['attributes.start_time DESC'],
    max_results=1,
    filter_string="attributes.status = 'FINISHED'"
)

if runs.empty:
    print('NOT_FOUND')
else:
    # Mengambil run_id dari DataFrame hasil pencarian
    print(runs.iloc[0].run_id) 
EOF
          )
          
          # Validasi dan Ekspor Output
          if [ "$RUN_ID" == "NOT_FOUND" ] || [ -z "$RUN_ID" ]; then
            echo "::error::Tidak dapat menemukan RUN ID MLflow yang selesai. Deploy dibatalkan."
            exit 1
          fi

          # Format URI model MLflow: runs:/<run_id>/<artifact_path>
          ARTIFACT_PATH="runs:/$RUN_ID/model" 
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "Model Artifact Path yang ditemukan: $ARTIFACT_PATH"

      # Langkah 7: Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }} 

      # Langkah 8: Build dan Push Docker Image (CD)
      - name: Build and Push Docker Image
        run: |
          echo "Memulai proses Build dan Push Docker Image..."
          # Export URI lagi untuk CLI
          export MLFLOW_TRACKING_URI="${{ env.MLFLOW_RUNS_PATH }}" 
          
          # Build dan Tag docker image, lalu --push ke Docker Hub
          conda run -n mlflow-env mlflow models build-docker \
            --model-uri ${{ steps.get_model_path.outputs.artifact_path }} \
            --name ${{ env.DOCKER_IMAGE_NAME }}:latest \
            --install-mlflow \
            --port ${{ env.MODEL_PORT }} \
            --push
            
          echo "âœ… Docker image ${{ env.DOCKER_IMAGE_NAME }}:latest berhasil dibuat dan didorong ke Docker Hub."
