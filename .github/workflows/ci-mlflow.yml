name: ðŸš€ CI/CD - MLflow TensorFlow Re-training & Artifact Storage

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'MLProject/**'
  workflow_dispatch: 

jobs:
  train-and-upload: 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # Langkah 1: Setup Python (Menggantikan Conda)
      - name: ðŸ“¦ Set up Python 3.10.13
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.13" 
          
      # Langkah 2: Install Dependencies (Menggunakan pip, menghindari masalah Conda)
      - name: ðŸ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # Instal semua dependencies dari conda.yaml melalui pip
          pip install \
            tensorflow==2.13.0 \
            mlflow==2.19.0 \
            scikit-learn==1.3.0 \
            pandas==2.1.0 \
            numpy==1.24.0 \
            cloudpickle==3.1.0

      # Langkah 3: RUN MLFLOW PROJECT (Re-training)
      - name: ðŸš€ Run MLflow Project and Retrain Model
        id: run-mlflow
        shell: bash
        run: |
          echo "Memulai pelatihan model TensorFlow via MLflow Project..."
          
          # Jalankan MLflow Project. --env-manager=local menggunakan environment pip yang sudah aktif
          mlflow run MLProject --env-manager=local
          
      # Langkah 4: Get latest run_id (Diperlukan untuk Artefak)
      - name: ðŸ†” Get latest MLflow run_id
        id: get-run-id
        run: |
          # Perintah ini mengambil ID run terbaru yang dibuat oleh MLflow
          RUN_ID=$(ls -td mlruns/0/*/ | head -n 1 | cut -d'/' -f3)
          echo "latest_run_id=$RUN_ID" >> $GITHUB_OUTPUT 
          echo "Latest run_id: $RUN_ID"
          

      # Langkah 5: ARTIFACT STORAGE (Memenuhi kriteria Skilled)
      - name: ðŸ’¾ Upload mlruns Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: tensorflow-model-artefacts-${{ github.run_id }}
          path: mlruns
          retention-days: 7
